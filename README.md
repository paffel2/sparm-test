# sparm-test. Тестовое задание для компании СП.АРМ.

## Задание

    Развернуть АПИ (фреймворк языка на усмотрение, но желательно что-то легковесное наподобие Flask для Python) для приема документов от внешних заказчиков, со следующими возможностями: 
    1) Принимать и обрабатывать Post запросы с данными в формате JSON (пример содержимого запроса example.json)
    Под обработкой понимается валидация данных, создание/поиск/обновление/удаление пользователя и/или его документов 
    2) Авторизация пользователя по данным из БД (поля login/password таблицы Users. Password в БД обязательно должен быть закодирован в base64)
    3) Отображение информации и документов об авторизованном пользователе
    4) Отображение информации о всех пользователях их документах (доступно только админу)
    5) Сделать соответствующее описания созданного сервиса в readme.md и выгрузить в свой репозиторий, указанный в резюме (если не указан - скинуть ссылку)

    Описание основных полей посылки JSON:
    "id"           - уникальный идентификатор посылки (обязательный)
    "referralGUID" - уникальный ГУИД посылки (обязательный)
    "referralDate" - дата отправки посылки  (обязательный)
    "Data"         - массив объектов с данными пользователей
     - "Sender"       - объект с данными отправителя посылки
        - "Organization" - объект с данными об организации отправителя посылки
           - "oid"          - уникальный идентификатор организации
           - "fullName"     - полное наименование организации
     - "Users"        - массив объектов с данными пользователей
        - "id"           - уникальный идентификатор пользователя (обязательный)
        - "lastName"     - фамилия пользователя (обязательный)
        - "firstName"    - имя пользователя
        - "patrName"     - отчество пользователя
        - "birthDate"    - дата рождения 
        - "sex"          - пол
        - "phoneNumber"  - номер телефона (обязательный)
        - "snils"        - снилс
        - "inn"          - ИНН
        - "Address"      - объект с данными адреса
           - "value"        - строка с полным адресом
        - "Documents"    - массив объектов с данными документов
           - "id"                - id документа
           - "documentType_id"   - тип (полис, паспорт и т д)
           - "documentType_name" - полное наименование
           - "series"            - серия
           - "number"            - номер
           - "beginDate"         - дата начала действия
           - "endDate"           - дата окончания действия
           - "orgDep_name"       - кем выдан

    Примечания:
     - Вывод информации на усмотрение исполнителя, но в выводе должны присутствовать все основные поля из описания посылки
     - Отметка (обязательный) у поля в структуре JSON указывает на то, что наличие данного поля и его значения гарантируется в посылке
     - Названия точек запроса (url) на усмотрение исполнителя
     - Обязательные поля для создания записей в БД:
       -- Пользователь (users): login, password, gender, type_id, last_name, first_name
       -- Документы (documents): user_id, type_id, data
           --- В поле data должен быть записан текст в формате JSON с данными документов пользователя (см. "Структура JSON с данными документов")
     - Описание полей таблиц БД находится в комментариях к этим полям в таблицах

    "Структура JSON с данными документов"
    [
          // первый документ
       {
          referralId   - уникальный идентификатор посылки
          referralDate - дата отправки посылки 
          senderName   - полное наименование организации отправителя
          name         - полное наименование документа (при наличии),
          series       - серия (обязателен для паспорта),
          number       - номер,
          beginDate    - дата начала действия (обязателен для паспорта и полиса),
          endDate      - дата окончания действия (при наличии),
          issuedName  - кем выдан (обязателен для паспорта и полиса)
    },
          // второй документ 
        {
    },
        ...
        // n-ный документ
        {
        }   
    ]


## Описание стека

Приложение реализовано я языке [Python](https://www.python.org/), с использованием веб-фреймворка [FastAPI](https://fastapi.tiangolo.com/). В качестве базы данных используется [MySQL](https://www.mysql.com/). Для работы с базой данных используется [SQLAlchemy](https://www.sqlalchemy.org/). Для валидации запросов используется библиотека [Pydantic](https://docs.pydantic.dev/latest/). FastAPI выбран, так как удобен в проектировании API, поддерживает валидацию с помощью Pydantic, позволяет автоматически генерировать документацию в формате Openapi. MySQL была выбрана, так как наряду с текстом задания, описание базы данных было составлено для MySQL. Для работы с базой с использованием возможностей ORM используется библиотека SQLAlchemy. Для миграций используется [Alembic](https://alembic.sqlalchemy.org/en/latest/), который позволяет генерировать миграции (с некоторыми допущениями) на основе разработанных SQLAlchemy-Моделей. Также используется [Docker](https://www.docker.com/) для развертывания приложения.

## Структура проекта

    ├── alembic.ini - файл с настройками Alembic
    ├── docker-compose.yml - файл docker compose
    ├── Dockerfile - docker file для создания образа сервера
    ├── env_template - файл окружения
    ├── example (1).json - пример тела POST-запроса
    ├── README.md - файл с описанием
    ├── requirements.txt - файл, содержащий имена всех необходимых библиотек 
    ├── src - папка с основным файлами проекта
    │   ├── common.py - модуль содержащий различные дополнительные функции
    │   ├── config.py - модуль с настройками проекта
    │   ├── database.py - модуль с функциями и классами для работы с базой данных
    │   ├── depends.py - файл с функциями, которыеи используются в зависимостях
    │   ├── exceptions.py - файл содержит классы исключений
    │   ├── main.py - основной файл для запуска проекта
    │   ├── migration - папка с миграциями
    │   │   ├── env.py - файл содержащий настройки и функции Alembic
    │   │   ├── README - описание
    │   │   ├── script.py.mako - сгенерированый файл Alembic
    │   │   └── versions - миграции
    │   │       ├── 001_init.py - начальная миграция
    │   │       ├── 002_test_data.py - миграция с первичными данными
    │   │       ├── __init__.py
    │   ├── models.py - файл с моделями для работы с базой данных
    │   ├── queries.py - файл с функциями работы с базой данных
    │   ├── router.py - реализация роутера и эндпоинтов
    │   └── schemas.py - файл с pydantic схемами
    ├── test 20240209 1754.sql - файл с описанием базы данных
    └── Задание (1).txt - текст задания

## Запуск

Для запуска выполните следующую команду.

    docker compose up

## Описание эндпоинтов

Все эндпоинты и краткое сгенрированное описание будет доступно после запуска проекта по ссылке:

    http://localhost:8000/docs

### Эндпоинты

    POST /api/add_information

Запрос для добавления данных из посылки. Для авторизации в заголовках `login` и `password` необходимо передать логин и пароль. При отправке запроса все данные из послыки будут провалидированы. Если при валидации возникнет ошибка, запрос будет полностью отклонен. При обработке, данные из каждой посылки будут зарегистрированы в базе. Организация будет добавлена, если она отсутствует. Дополнительные поля, переданные с пользователем, будут проигнорированы. Дополнительные поля переданные с документами, будут записаны. Возвращает сообщение об успешном выполнении.
Пример тела запроса:

    [
        {
        "id": 80087332,
        "referralGUID": "F234FG244422FFFFF4:232RFS",
        "referralDate": "2024-01-23T18:55:02",
        "Data": [
            {
            "Sender": {
                "Organization": {
                    "oid": "1.2.5.23.543.1234.18972",
                    "fullName": "СП.АРМ"
                }
            },
            "Users": [
                {
                    "id": 1504926,
                    "lastName": "Иванова",
                    "firstName": "Екатерина",
                    "patrName": "Петровна",
                    "birthDate": "1996-06-08",
                    "sex": "2",
                    "phoneNumber": "9999999999",
                    "snils": "12495797018",
                    "inn": "027801597819",
                    "socStatus_id": "102",
                    "socStatusFed_Code": "8",
                    "pid": null,
                    "parPersonSurName_SurName": null,
                    "parPersonFirName_FirName": null,
                    "parPersonSecName_SecName": null,
                    "deputyKind_id": null,
                    "deputyOrg_id": "0",
                    "documentAuthority_id": null,
                    "documentDeputy_Ser": null,
                    "documentDeputy_Num": null,
                    "documentDeputy_Issue": null,
                    "documentDeputy_begDate": null,
                    "legalStatusVZN_id": null,
                    "legalStatusVZN_Name": null,
                    "legalStatusVZN_pid": null,
                    "legalStatusVZN_pName": null,
                    "employment_id": null,
                    "familyStatus_id": null,
                    "personFamilyStatus_IsMarried": null,
                    "Credentials":{
                        "username": "login",
                        "password": "pwd"
                    },
                    "Address": {
                        "id": "11337703",
                        "value": "450015, РОССИЯ, БАШКОРТОСТАН РЕСП, Г УФА, СОВЕТСКИЙ РАЙОН, РЫБНАЯ УЛ, д. 5, корп. Б, кв. ",
                        "org_id": null,
                        "post_id": null,
                        "guid": "8479A314-A179-4874-A8FD-AC7CED2BCEE5"
                    },           
                    "Documents": [
                        {
                        "id": "18382434", 
                        "documentType_id": 2,
                        "documentType_Name": "Полис ОМС",
                        "sprTerr_id": "1075",
                        "type": "ОМС",
                        "series": 12433,
                        "number": "0253310891000710",
                        "smo_id": "8000229",
                        "beginDate": "2021-12-14",
                        "endDate": null,
                        "orgDep_Name": "РЕСО МЕД",
                        "formType_id": "3",
                        "lpu_id": "150028"
                        },
                        {
                        "id": "18383277",
                        "documentType_id": "1",
                        "documentType_Name": "Паспорт гражданина Российской Федерации",
                        "series": "86 21",
                        "number": "407195",
                        "beginDate": "2021-11-02",
                        "endDate": null,
                        "isTwoNation": null,
                        "orgDep_id": "32625",
                        "orgDep_Name": "МВД по Республике Башкортостан",
                        "personEvn_begDT": "2023-10-26 08:58:19",
                        "lpu_id": "150028"
                        }
                    ]
                }
            ]        
            }
        ]
        }
    ]

_

    GET /api/get_personal_info

Запрос для получения пользовательских данных и документов. Для авторизации в заголовках `login` и `password` необходимо передать логин и пароль. Возвращает ответ с информацией, пренадлежащей пользователю с указанным логином и паролем.
Пример тела ответа:

    {
    "id": 0,
    "type_id": 0,
    "lastName": "string",
    "firstName": "string",
    "patrName": "string",
    "gender_id": 0,
    "documents": [
        {
        "id": 0,
        "type_id": 0,
        "data": {
            "documentType_name": "string",
            "series": "string",
            "number": "string",
            "beginDate": "2024-08-05",
            "endDate": "2024-08-05",
            "orgDep_Name": "string",
            "additionalProp1": {}
        },
        "additionalProp1": {}
        }
    ]
    }
_

    GET /api/get_users_data

Запрос на получения списка пользовательских данных. Доступен только администратору. Для авторизации в заголовках `login` и `password` необходимо передать логин и пароль. Принимает параметр `page`, для вывода ограниченного числа пользователей.
Пример тела ответа:

    [
    {
        "id": 0,
        "type_id": 0,
        "lastName": "string",
        "firstName": "string",
        "patrName": "string",
        "gender_id": 0,
        "documents": [
        {
            "id": 0,
            "type_id": 0,
            "data": {
            "documentType_name": "string",
            "series": "string",
            "number": "string",
            "beginDate": "2024-08-05",
            "endDate": "2024-08-05",
            "orgDep_Name": "string",
            "additionalProp1": {}
            },
            "additionalProp1": {}
        }
        ]
    }
    ]

_

    DELETE /api/delete_user_info

Запрос на удаление  пользовательских данных. Доступен администратору и владельцу данных. Для авторизации в заголовках `login` и `password` необходимо передать логин и пароль. Если администратор удаляет данные, ему необходимо передать параметр `user_id`. После выполнения у указанного пользователя и его документов поле `deleted` станет равно 1, но данные при этом не будут стерты. После выполнения будет возвращено сообщение об успешном выполнении.

    DELETE /api/delete_user_document

Запрос на удаление документа. Доступен администратору и владельцу данных. Для авторизации в заголовках `login` и `password` необходимо передать логин и пароль. Для удаления обязателен параметр `document_id`. После выполнения у указанного документа `deleted` станет равно 1, но данные при этом не будут стерты. После выполнения будет возвращено сообщение об успешном выполнении.

    PUT /api/update_user

Запрос на обновление пользовательских данных. Доступен администратору и владельцу данных. Для авторизации в заголовках `login` и `password` необходимо передать логин и пароль. Если администратор обновляет данные, ему необходимо передать параметр `user_id`. После выполнения будет возвращено сообщение об успешном изменении.
Пример тела запроса:

    {
    "lastName": "string",
    "firstName": "string",
    "patrName": "string",
    "sex": 0,
    "login": "string",
    "password": "string"
    }

_

    PUT /api/update_document

Запрос на обновление документов. Доступен администратору и владельцу данных. Для авторизации в заголовках `login` и `password` необходимо передать логин и пароль. После выполнения будет возвращено сообщение об успешном изменении.
Пример тела запроса:

    {
    "documentType_name": "string",
    "series": "string",
    "number": "string",
    "beginDate": "2024-08-05",
    "endDate": "2024-08-05",
    "orgDep_Name": "string",
    "id": 0,
    "documentType_id": 0,
    }